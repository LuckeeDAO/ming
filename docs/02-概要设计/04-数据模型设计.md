# 数据模型设计

## 1. 数据模型概述

Ming平台采用混合存储架构：
- **链上存储**: NFT元数据、连接记录、能量场见证
- **IPFS存储**: 图片、详细记录、仪式内容
- **本地存储**: 用户临时数据、未发布内容

## 2. 核心数据模型

### 2.1 用户模型

#### 2.1.1 用户基础信息
```typescript
interface User {
  walletAddress: string;      // 钱包地址（主键）
  nickname?: string;          // 昵称（可选）
  avatar?: string;            // 头像（IPFS URL）
  createdAt: Date;           // 创建时间
  lastActiveAt: Date;         // 最后活跃时间
}
```

#### 2.1.2 用户四柱八字
```typescript
interface UserFourPillars {
  walletAddress: string;      // 用户钱包地址
  year: string;               // 年柱（如：甲子）
  month: string;              // 月柱
  day: string;                // 日柱
  hour: string;               // 时柱
  createdAt: Date;            // 创建时间
  updatedAt: Date;            // 更新时间
  // 注意：此数据不上链，仅本地存储或加密存储
}
```

### 2.2 能量分析模型

#### 2.2.1 能量系统分析
```typescript
interface EnergyAnalysis {
  walletAddress: string;      // 用户钱包地址
  analysisId: string;         // 分析ID
  fourPillars: FourPillars;   // 四柱八字
  
  // 五行能量分布
  fiveElements: {
    wood: {
      value: number;          // 能量值 (0-100)
      status: 'strong' | 'normal' | 'weak' | 'missing';
    };
    fire: {
      value: number;
      status: 'strong' | 'normal' | 'weak' | 'missing';
    };
    earth: {
      value: number;
      status: 'strong' | 'normal' | 'weak' | 'missing';
    };
    metal: {
      value: number;
      status: 'strong' | 'normal' | 'weak' | 'missing';
    };
    water: {
      value: number;
      status: 'strong' | 'normal' | 'weak' | 'missing';
    };
  };
  
  // 能量循环状态
  circulation: {
    status: 'smooth' | 'blocked' | 'weak';
    details: string;         // 循环情况说明
    blockedPoints: string[]; // 阻塞点
  };
  
  // 缺失元素
  missingElements: Array<{
    element: 'wood' | 'fire' | 'earth' | 'metal' | 'water';
    level: 'critical' | 'moderate' | 'minor';
    recommendation: string;   // 推荐外物
  }>;
  
  analyzedAt: Date;           // 分析时间
}
```

### 2.3 外物模型

#### 2.3.1 外物基础信息
```typescript
interface ExternalObject {
  id: string;                 // 外物ID
  name: string;               // 名称
  nameEn?: string;            // 英文名称
  element: 'wood' | 'fire' | 'earth' | 'metal' | 'water';
  category: 'nature' | 'mineral' | 'plant' | 'water' | 'fire' | 'other';
  
  // 描述信息
  description: string;        // 中文描述
  descriptionEn?: string;     // 英文描述
  image: string;              // 图片URL（IPFS）
  symbolImage?: string;       // 象征图片
  
  // 连接方式
  connectionMethods: ConnectionMethod[];
  
  // 推荐场景
  recommendedFor: Array<{
    element: string;          // 适合的能量类型
    reason: string;           // 推荐理由
  }>;
  
  // 文化背景
  culturalBackground?: {
    origin: string;           // 来源
    meaning: string;          // 文化意义
  };
}
```

#### 2.3.2 连接方式
```typescript
interface ConnectionMethod {
  type: 'symbolic' | 'experiential' | 'deep';
  name: string;               // 方式名称
  description: string;        // 描述
  steps: Array<{
    order: number;
    title: string;
    description: string;
    duration?: string;        // 预计时长
  }>;
  materials: Array<{
    name: string;
    required: boolean;        // 是否必需
    alternatives?: string[];  // 替代品
  }>;
  difficulty: 'easy' | 'medium' | 'hard';
  estimatedTime: string;      // 预计总时长
}
```

### 2.4 NFT模型

#### 2.4.1 NFT基础信息（链上）
```typescript
interface NFTOnChain {
  tokenId: string;            // Token ID
  owner: string;              // 所有者地址
  contractAddress: string;    // 合约地址
  tokenURI: string;           // 元数据URI（IPFS）
  mintedAt: number;           // 铸造时间戳（区块时间）
  txHash: string;             // 交易哈希
  blockNumber: number;        // 区块号
}
```

#### 2.4.2 NFT元数据（IPFS）
```typescript
interface NFTMetadata {
  // ERC-721 标准字段
  name: string;               // NFT名称
  description: string;         // 描述
  image: string;              // 图片URL（IPFS）
  
  // 扩展属性
  attributes: Array<{
    trait_type: string;
    value: string | number;
    display_type?: string;
  }>;
  
  // 连接信息
  connection: {
    externalObjectId: string;  // 外物ID
    externalObjectName: string;
    element: string;
    connectionType: string;    // 连接方式类型
    connectionDate: string;    // ISO日期字符串
  };
  
  // 仪式信息
  ceremony: {
    location?: string;         // 地点（可选）
    duration?: string;         // 时长
    participants?: number;     // 参与者数量
  };
  
  // 感受记录（可选，用户可控制是否包含）
  feelings?: {
    before: string;           // 仪式前感受
    during: string;           // 仪式中感受
    after: string;            // 仪式后感受
  };
  
  // 能量场见证
  energyField: {
    consensusHash: string;     // 共识哈希
    witnessCount?: number;     // 见证数量（如实现）
  };
  
  // 元数据
  metadata: {
    version: string;           // 元数据版本
    createdAt: string;         // 创建时间
    platform: 'ming';         // 平台标识
  };
}
```

### 2.5 连接记录模型

#### 2.5.1 连接记录（本地/链上）
```typescript
interface ConnectionRecord {
  id: string;                 // 记录ID
  walletAddress: string;      // 用户钱包地址
  nftTokenId: string;         // NFT Token ID
  nftContractAddress: string; // NFT合约地址
  
  // 连接信息
  externalObject: {
    id: string;
    name: string;
    element: string;
  };
  
  connectionDate: Date;       // 连接日期
  connectionType: string;     // 连接方式类型
  
  // 仪式信息
  ceremony: {
    location?: string;
    duration?: string;
    notes?: string;           // 仪式笔记
  };
  
  // 感受记录（本地存储，可选上链）
  feelings: {
    before: string;
    during: string;
    after: string;
    updatedAt: Date;
  };
  
  // 区块链信息
  blockchain: {
    txHash: string;
    blockNumber: number;
    gasUsed?: number;
  };
  
  // IPFS信息
  ipfs: {
    metadataHash: string;     // 元数据IPFS哈希
    imageHash?: string;       // 图片IPFS哈希
  };
  
  // 状态
  status: 'draft' | 'minted' | 'completed';
  createdAt: Date;
  updatedAt: Date;
}
```

### 2.6 能量场见证模型

#### 2.6.1 能量场见证（链上）
```typescript
interface EnergyFieldWitness {
  connectionId: string;       // 连接记录ID
  nftTokenId: string;         // NFT Token ID
  consensusHash: string;      // 共识哈希
  witnessData: {
    timestamp: number;        // 见证时间戳
    blockNumber: number;      // 区块号
    networkId: number;        // 网络ID
  };
  // 未来可扩展：见证者列表、见证权重等
}
```

## 3. 存储策略

### 3.1 链上存储

#### 3.1.1 必须上链的数据
- NFT所有权信息
- NFT Token ID和元数据URI
- 能量场见证记录
- 连接时间戳

#### 3.1.2 智能合约数据结构
```solidity
struct ConnectionNFT {
    uint256 tokenId;
    address owner;
    string tokenURI;          // IPFS元数据URI
    uint256 connectionDate;    // 连接时间戳
    string externalObjectId;   // 外物ID
    string element;            // 能量类型
    bytes32 consensusHash;     // 共识哈希
}
```

### 3.2 IPFS存储

#### 3.2.1 IPFS存储内容
- NFT图片
- NFT完整元数据JSON
- 仪式过程图片/视频（可选）
- 详细感受记录（可选）

#### 3.2.2 IPFS文件结构
```
ipfs://{hash}/
├── metadata.json          # NFT元数据
├── image.jpg             # NFT图片
└── ceremony/             # 仪式内容（可选）
    ├── images/
    └── notes.json
```

### 3.3 本地存储

#### 3.3.1 localStorage存储
```typescript
interface LocalStorageData {
  // 用户设置
  settings: {
    language: 'zh' | 'en';
    theme: 'light' | 'dark';
    network: 'mainnet' | 'testnet';
  };
  
  // 临时数据
  drafts: {
    connectionDraft?: ConnectionDraft;
    feelingDraft?: FeelingDraft;
  };
  
  // 缓存数据
  cache: {
    energyAnalysis?: EnergyAnalysis;
    externalObjects?: ExternalObject[];
    lastUpdateTime: number;
  };
}
```

#### 3.3.2 敏感数据存储
- **四柱八字**: 加密存储或仅内存存储
- **详细感受**: 用户选择是否上链/IPFS
- **钱包信息**: 仅连接状态，不存储私钥

## 4. 数据关系图

```
User (钱包地址)
  ├── UserFourPillars (1:1)
  ├── EnergyAnalysis (1:N)
  └── ConnectionRecord (1:N)
        ├── NFTOnChain (1:1)
        ├── NFTMetadata (1:1, IPFS)
        ├── ExternalObject (N:1)
        └── EnergyFieldWitness (1:1)
```

## 5. 数据验证规则

### 5.1 输入验证
- 四柱八字格式验证
- 钱包地址格式验证
- 图片格式和大小限制
- 文本长度限制

### 5.2 数据完整性
- 必填字段检查
- 关联数据一致性
- 链上数据与IPFS数据一致性

## 6. 数据迁移和版本管理

### 6.1 元数据版本
- 版本号管理
- 向后兼容性
- 迁移策略

### 6.2 数据备份
- IPFS数据备份
- 本地数据导出
- 链上数据查询

## 7. 隐私和安全

### 7.1 隐私保护
- 四柱八字信息不上链
- 用户可选择感受记录是否公开
- 本地数据加密存储

### 7.2 数据安全
- 输入验证和清理
- XSS防护
- 数据加密传输

## 8. 数据查询和索引

### 8.1 链上查询
- 通过钱包地址查询NFT
- 通过Token ID查询NFT信息
- 通过合约事件查询连接记录

### 8.2 本地索引
- 连接记录索引（按时间、外物、元素）
- 用户档案索引
- 缓存数据索引
