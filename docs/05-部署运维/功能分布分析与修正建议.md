# Ming 平台功能分布分析与修正建议

## 文档信息

- **创建日期**: 2026-01-31
- **背景**: NFT铸造功能迁移到钱包后，需要重新评估功能分布
- **目标**: 确保功能边界清晰，职责分离合理

---

## 1. 当前功能分布分析

### 1.1 页面功能分布

| 页面 | 路径 | 当前功能 | 职责 |
|------|------|---------|------|
| 首页 | `/` | 平台介绍、核心理念、行动号召 | ✅ 保留 |
| 连接指导 | `/connection-guide` | 能量分析、外物推荐、选择外物、准备连接 | ✅ 保留 |
| NFT仪式 | `/nft-ceremony` | **准备→内容创建→铸造→完成** | ⚠️ 需要重构 |
| 我的连接 | `/my-connections` | 查看历史连接记录和NFT | ✅ 保留 |
| 仪式资源 | `/ceremony-resources` | 仪式指南和素材库 | ✅ 保留 |
| 定时MINT | `/scheduled-mints` | 定时铸造任务管理 | ⚠️ 需要调整 |

### 1.2 服务层功能分布

| 服务 | 文件 | 当前功能 | 迁移后状态 |
|------|------|---------|-----------|
| IPFS服务 | `services/ipfs/ipfsService.ts` | 图片和元数据上传 | ⚠️ 需要调整 |
| 合约服务 | `services/contract/nftContract.ts` | NFT铸造、查询 | ❌ 移除或简化 |
| 能量分析 | `services/energy/energyAnalysisService.ts` | 四柱八字分析 | ✅ 保留 |
| 外物服务 | `services/energy/externalObjectService.ts` | 外物数据管理 | ✅ 保留 |
| 钱包服务 | `services/wallet/walletService.ts` | 钱包连接 | ✅ 保留 |
| 定时MINT | `services/scheduledMint/scheduledMintService.ts` | 定时任务管理 | ⚠️ 需要调整 |

---

## 2. 问题分析

### 2.1 当前架构问题

#### ❌ 问题1：NFT仪式页面职责过重

**当前状态**：
- `/nft-ceremony` 页面包含完整的铸造流程
- 包括：IPFS上传、元数据生成、合约调用、共识哈希生成
- 这些功能应该由钱包处理

**影响**：
- 与钱包功能重复
- 维护成本高
- 不符合职责分离原则

#### ❌ 问题2：IPFS服务在Ming平台中

**当前状态**：
- Ming平台直接处理IPFS上传
- 包含图片和元数据上传逻辑

**影响**：
- 根据需求说明书，IPFS上传应该由钱包处理
- 或者Ming平台完成上传后，将结果传递给钱包

#### ❌ 问题3：合约服务耦合

**当前状态**：
- `nftContractService` 直接调用智能合约
- 包含铸造、查询等完整功能

**影响**：
- 铸造功能应该由钱包处理
- 查询功能可能需要保留（用于展示）

#### ❌ 问题4：定时MINT功能位置不清

**当前状态**：
- 定时MINT在Ming平台中实现
- 但实际铸造需要调用钱包

**影响**：
- 功能边界不清晰
- 需要明确定时任务的执行位置

---

## 3. 修正建议

### 3.1 功能边界重新定义

#### ✅ Ming平台应该负责（业务逻辑层）

1. **用户交互和数据收集**
   - 四柱八字输入
   - 能量分析展示
   - 外物推荐和选择
   - 仪式信息填写（感受、祝福等）
   - 图片选择（本地预览）

2. **业务数据处理**
   - 能量分析计算
   - 外物推荐算法
   - NFT元数据生成（业务字段）
   - 连接记录管理

3. **展示和查询**
   - 历史连接记录展示
   - NFT信息展示（从链上查询）
   - 仪式资源展示

#### ✅ 钱包应该负责（基础设施层）

1. **IPFS上传**
   - 图片上传到IPFS
   - 元数据上传到IPFS
   - 返回IPFS哈希

2. **区块链交互**
   - 合约调用（铸造NFT）
   - 交易签名
   - 交易状态跟踪

3. **共识哈希生成**
   - 根据元数据哈希生成共识哈希

### 3.2 页面重构建议

#### 📝 建议1：重构 NFT仪式页面

**当前流程**：
```
准备阶段 → 内容创建 → 铸造阶段 → 完成阶段
```

**建议流程**：
```
准备阶段 → 内容创建 → 调用钱包 → 完成阶段
```

**具体修改**：

1. **保留的功能**：
   - ✅ 外物选择确认
   - ✅ 图片选择（本地预览，不上传）
   - ✅ 仪式信息填写（感受、祝福、连接类型等）
   - ✅ 元数据预览（展示将要生成的元数据）

2. **移除的功能**：
   - ❌ IPFS上传逻辑
   - ❌ 合约调用逻辑
   - ❌ 共识哈希生成逻辑

3. **新增的功能**：
   - ✅ 调用钱包接口（传递准备好的数据）
   - ✅ 显示钱包处理进度
   - ✅ 接收钱包返回结果

**代码修改示例**：

```typescript
// 修改前：直接调用IPFS和合约
const handleMint = async () => {
  const imageHash = await ipfsService.uploadFile(formData.image);
  const metadata = generateMetadata(...);
  const metadataHash = await ipfsService.uploadJSON(metadata);
  const consensusHash = ethers.keccak256(...);
  const txHash = await nftContractService.mintConnection(...);
};

// 修改后：调用钱包接口
const handleMint = async () => {
  // 1. 生成元数据（不上传）
  const metadata = generateMetadata(...);
  
  // 2. 调用钱包接口
  const result = await walletService.mintNFT({
    image: formData.image,
    metadata: metadata,
    contract: {
      address: CONTRACT_ADDRESS,
      chainId: CHAIN_ID,
    },
  });
  
  // 3. 处理返回结果
  if (result.success) {
    // 保存连接记录
    saveConnectionRecord(result.data);
  }
};
```

#### 📝 建议2：调整 IPFS服务职责

**方案A（✅ 采用）**：Ming平台完成IPFS上传，钱包只负责合约调用

- ✅ Ming平台：上传图片和元数据到IPFS
- ✅ Ming平台：生成共识哈希
- ✅ 钱包：接收IPFS哈希和共识哈希，调用合约

**方案B**：钱包完成所有IPFS和合约操作

- ✅ Ming平台：准备元数据JSON（不上传）
- ✅ 钱包：上传图片和元数据到IPFS
- ✅ 钱包：生成共识哈希并调用合约

**采用方案A**，因为：
- ✅ Ming平台可以控制元数据格式，确保符合业务需求
- ✅ 钱包接口更简单（只需接收已准备好的参数），符合最小化接口原则
- ✅ 符合需求说明书中的推荐方案
- ✅ 职责分离更清晰：Ming平台处理业务数据，钱包处理基础设施

#### 📝 建议3：简化合约服务

**保留的功能**：
- ✅ 查询用户NFT列表
- ✅ 查询NFT详情
- ✅ 查询连接信息

**移除的功能**：
- ❌ 铸造NFT（由钱包处理）
- ❌ 更新共识哈希（如果需要，由钱包处理）

**修改后的服务**：

```typescript
// 保留查询功能
class NFTContractService {
  // 查询功能保留
  async getUserTokens(userAddress: string): Promise<string[]>;
  async getConnectionInfo(tokenId: string): Promise<ConnectionInfo>;
  async getUserNFTs(userAddress: string): Promise<NFTOnChain[]>;
  
  // 移除铸造功能
  // async mintConnection(...) - 移除
}
```

#### 📝 建议4：调整定时MINT功能

**当前问题**：
- 定时MINT在Ming平台中，但需要调用钱包

**建议方案**：

**方案A**：Ming平台管理定时任务，执行时调用钱包
- ✅ Ming平台：存储定时任务
- ✅ Ming平台：定时检查并触发
- ✅ 钱包：执行实际的铸造操作

**方案B**：将定时任务交给钱包管理（✅ 推荐）
- ✅ Ming平台：创建定时任务并传递给钱包
- ✅ 钱包：管理定时任务并执行

**采用方案B**，因为：
- 钱包自带定时功能，可以更好地管理定时任务
- 减少Ming平台的复杂度，不需要维护定时任务调度
- 钱包可以统一管理所有定时任务，包括其他应用的定时任务
- 更符合职责分离原则（基础设施由钱包负责）

---

## 4. 具体实施步骤

### 4.1 第一阶段：重构NFT仪式页面

1. **保留IPFS上传逻辑**（方案A）
   - ✅ 保留图片选择（本地预览）
   - ✅ 保留 `ipfsService.uploadFile()` 调用（上传图片到IPFS）
   - ✅ 保留 `ipfsService.uploadJSON()` 调用（上传元数据到IPFS）
   - ✅ 保留共识哈希生成逻辑（在Ming平台完成）

2. **移除合约调用逻辑**
   - ❌ 移除 `nftContractService.mintConnection()` 调用
   - ✅ 保留共识哈希生成（在Ming平台完成）

3. **添加钱包接口调用**
   - ✅ 实现钱包接口调用（传递IPFS哈希和共识哈希）
   - ✅ 添加进度显示
   - ✅ 处理返回结果

### 4.2 第二阶段：调整服务层

1. **保留IPFS服务**（采用方案A）
   - ✅ 保留IPFS上传功能
   - ✅ 保留图片上传到IPFS
   - ✅ 保留元数据上传到IPFS
   - ✅ 保留IPFS访问URL生成
   - ✅ 保留共识哈希生成（基于IPFS哈希）

2. **简化合约服务**
   - 移除铸造相关方法
   - 保留查询相关方法

3. **调整定时MINT服务**（采用方案B）
   - 移除定时任务调度逻辑（由钱包负责）
   - 修改为调用钱包接口创建定时任务
   - 移除本地定时任务存储

### 4.3 第三阶段：更新相关页面

1. **更新连接指导页面**
   - 确保跳转到NFT仪式页面的流程正确

2. **更新我的连接页面**
   - 确保NFT查询功能正常（使用简化后的合约服务）

3. **更新定时MINT页面**
   - 调整定时任务的创建逻辑（调用钱包接口）
   - 移除定时任务执行逻辑（由钱包负责）
   - 添加定时任务状态查询（从钱包获取）

---

## 5. 功能分布对比表

### 5.1 修改前 vs 修改后

| 功能 | 修改前 | 修改后 |
|------|--------|--------|
| **IPFS上传** | Ming平台 | Ming平台 ✅（方案A） |
| **元数据生成** | Ming平台 | Ming平台 ✅ |
| **共识哈希生成** | Ming平台 | Ming平台 ✅（方案A） |
| **合约调用** | Ming平台 | 钱包 ✅ |
| **交易签名** | Ming平台（通过MetaMask） | 钱包 ✅ |
| **NFT查询** | Ming平台 | Ming平台 ✅ |
| **能量分析** | Ming平台 | Ming平台 ✅ |
| **外物推荐** | Ming平台 | Ming平台 ✅ |
| **连接记录管理** | Ming平台 | Ming平台 ✅ |
| **定时MINT** | Ming平台 | 钱包 ✅（方案B） |

### 5.2 推荐方案（方案A）

| 功能 | 负责方 | 说明 |
|------|--------|------|
| **用户交互** | Ming平台 | 所有用户界面和交互 |
| **业务逻辑** | Ming平台 | 能量分析、外物推荐、元数据生成 |
| **IPFS上传** | Ming平台 | 上传图片和元数据 |
| **共识哈希** | Ming平台 | 生成共识哈希 |
| **合约调用** | 钱包 | 调用智能合约铸造NFT |
| **交易签名** | 钱包 | 用户签名确认 |
| **数据查询** | Ming平台 | 查询链上NFT信息 |
| **定时任务管理** | 钱包 | 创建、存储、执行定时任务（方案B） |

---

## 6. 代码修改清单

### 6.1 需要修改的文件

#### 页面文件
- [ ] `srcs/src/pages/NFTCeremony/index.tsx` - 重构铸造流程
- [ ] `srcs/src/pages/ScheduledMints/index.tsx` - 调整定时任务逻辑

#### 服务文件
- [ ] `srcs/src/services/contract/nftContract.ts` - 移除铸造方法
- [ ] `srcs/src/services/ipfs/ipfsService.ts` - **保留IPFS上传功能**（方案A）
- [ ] `srcs/src/services/scheduledMint/scheduledMintService.ts` - **重构为调用钱包接口创建定时任务**（移除调度逻辑）
- [ ] `srcs/src/services/wallet/walletService.ts` - 添加钱包接口调用

#### Hook文件
- [ ] `srcs/src/hooks/useNFT.ts` - 调整NFT相关操作
- [ ] `srcs/src/hooks/useScheduledMint.ts` - **移除定时任务调度逻辑，改为调用钱包接口**

### 6.2 需要新增的文件

- [ ] `srcs/src/services/wallet/mingWalletInterface.ts` - 钱包接口封装
- [ ] `srcs/src/types/wallet.ts` - 钱包接口类型定义

---

## 7. 风险评估

### 7.1 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 钱包接口未实现 | 高 | 与钱包团队确认接口规范 |
| 数据格式不匹配 | 中 | 详细定义接口规范，充分测试 |
| 用户体验下降 | 中 | 优化交互流程，提供清晰的进度反馈 |

### 7.2 业务风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 功能边界不清 | 中 | 明确文档，定期沟通 |
| 开发进度延迟 | 中 | 分阶段实施，优先核心功能 |

---

## 8. 实施优先级

### 高优先级（必须完成）
1. ✅ 重构NFT仪式页面，移除合约调用
2. ✅ 实现钱包接口调用
3. ✅ 简化合约服务，移除铸造方法

### 中优先级（重要）
4. ✅ 调整定时MINT功能（采用方案B，由钱包管理）
5. ✅ 更新相关页面和组件
6. ✅ 实现钱包定时任务接口调用

### 低优先级（可选）
6. ⚠️ 优化用户体验
7. ⚠️ 添加错误处理和重试机制

---

## 9. 总结

### 9.1 核心原则

1. **职责分离**：Ming平台负责业务逻辑，钱包负责基础设施
2. **接口清晰**：定义清晰的接口规范，减少耦合
3. **渐进式迁移**：分阶段实施，降低风险

### 9.2 关键修改点

1. **NFT仪式页面**：从"完整流程"改为"IPFS上传+调用钱包"
2. **合约服务**：从"完整功能"改为"仅查询功能"
3. **IPFS服务**：**保留IPFS上传功能**（方案A：Ming平台完成上传）
4. **定时MINT服务**：从"Ming平台管理"改为"钱包管理"（方案B）

### 9.3 下一步行动

1. 与钱包团队确认接口规范（包括定时任务接口）
2. 开始重构NFT仪式页面
3. 调整定时MINT功能（采用方案B，由钱包管理）
4. 逐步迁移其他功能

### 9.4 钱包接口需求（补充）

**NFT铸造接口**（方案A：Ming平台完成IPFS上传）：

```typescript
// 立即铸造NFT
interface MintNFTRequest {
  // IPFS哈希（Ming平台已上传）
  ipfs: {
    imageHash: string;          // 图片IPFS哈希
    metadataHash: string;       // 元数据IPFS哈希
    imageURI: string;           // 图片IPFS访问URL
    tokenURI: string;           // 元数据IPFS访问URL
  };
  
  // 共识哈希（Ming平台已生成）
  consensusHash: string;        // bytes32格式的共识哈希
  
  // 合约调用参数
  contract: {
    address: string;            // NFT合约地址
    chainId: number;            // 链ID
  };
  
  // 合约方法参数（用于mintConnection方法）
  params: {
    to: string;                 // NFT接收地址
    tokenURI: string;           // IPFS元数据URI
    externalObjectId: string;   // 外物ID
    element: string;            // 五行属性
    consensusHash: string;      // 共识哈希
  };
}

interface MintNFTResponse {
  success: boolean;
  data?: {
    tokenId: string;            // 铸造的Token ID
    txHash: string;             // 交易哈希
    blockNumber: number;        // 区块号
  };
  error?: {
    code: string;
    message: string;
  };
}
```

**定时任务相关接口**：

```typescript
// 创建定时任务（方案A：Ming平台完成IPFS上传）
interface CreateScheduledTaskRequest {
  scheduledTime: string;        // ISO格式时间
  
  // IPFS哈希（Ming平台已上传）
  ipfs: {
    imageHash: string;          // 图片IPFS哈希
    metadataHash: string;       // 元数据IPFS哈希
    imageURI: string;           // 图片IPFS访问URL
    tokenURI: string;           // 元数据IPFS访问URL
  };
  
  // 共识哈希（Ming平台已生成）
  consensusHash: string;        // bytes32格式的共识哈希
  
  // 合约调用参数
  contract: {
    address: string;            // NFT合约地址
    chainId: number;            // 链ID
  };
  
  // 合约方法参数
  params: {
    to: string;                 // NFT接收地址
    tokenURI: string;           // IPFS元数据URI
    externalObjectId: string;   // 外物ID
    element: string;            // 五行属性
    consensusHash: string;      // 共识哈希
  };
}

interface CreateScheduledTaskResponse {
  success: boolean;
  data?: {
    taskId: string;              // 任务ID
    scheduledTime: string;
    status: 'pending' | 'executing' | 'completed' | 'failed';
  };
}

// 查询定时任务
interface GetScheduledTaskResponse {
  success: boolean;
  data?: {
    taskId: string;
    scheduledTime: string;
    status: string;
    result?: {
      tokenId?: string;
      txHash?: string;
      error?: string;
    };
  };
}

// 取消定时任务
interface CancelScheduledTaskRequest {
  taskId: string;
}
```

---

**文档结束**
