# 钱包联调验收清单

> 基线版本：v1.0（参照 `docs/00-现行口径基线.md`）

## 1. 范围与目标

本清单用于外部钱包工程与 Ming 平台联调验收，覆盖：

- 消息协议正确性
- 功能闭环完整性
- 安全与稳定性
- 线上可运维性

通过标准：关键项全部通过（`[x]`），阻断项为 0。

---

## 2. 协议一致性（阻断项）

- [ ] 已确认 `权限路径决策与实施清单.md` 的现行决策并完成前置动作
- [ ] `mintConnection` 对 owner 与非 owner 账户均可执行
- [ ] 请求/响应命名符合：`MING_WALLET_<ACTION>_REQUEST/RESPONSE`
- [ ] `messageId` 原样回传，且仅响应一次
- [ ] 响应体统一为 `payload.success/data/error`
- [ ] 未识别 `type` 被安全忽略（不广播错误消息）
- [ ] 超时场景可控（Ming 侧 300s 内有最终响应或失败）

---

## 3. 必实现接口（阻断项）

- [ ] `MINT_NFT` 请求/响应可用
- [ ] `CREATE_SCHEDULED_TASK` 请求/响应可用
- [ ] `GET_SCHEDULED_TASK` 请求/响应可用
- [ ] `GET_SCHEDULED_TASKS_BY_WALLET` 请求/响应可用
- [ ] `CANCEL_SCHEDULED_TASK` 请求/响应可用
- [ ] `RELEASE_CONNECTION_NFT` 请求/响应可用

---

## 4. 字段与参数校验

- [ ] `consensusHash` 校验：`0x` + 64 hex（长度 66）
- [ ] `contract.address`、`params.to` 按 `contract.chainFamily` 校验地址格式（`evm`/`solana`）
- [ ] EVM：`contract.chainId` 与钱包当前链一致，不一致返回 `CHAIN_NOT_SUPPORTED`
- [ ] Solana：`contract.network` 必填且与钱包当前网络一致，不一致返回 `CHAIN_NOT_SUPPORTED`
- [ ] `params.tokenURI` 仅允许 `ipfs://` 或 `https://` 协议
- [ ] `scheduledTime` 为未来 ISO 时间，否则 `INVALID_SCHEDULED_TIME`
- [ ] `timing.requestedAt/executeAt` 为合法 ISO 时间
- [ ] `CREATE_SCHEDULED_TASK` 中 `timing.executeAt === scheduledTime` 且 `timing.strategy='scheduled'`
- [ ] `protocolVersion` 固定为 `1.0.0`
- [ ] 缺失关键字段时返回 `INVALID_PARAMS` / `MISSING_REQUIRED_FIELD`

---

## 5. 功能流程验收

### 5.1 立即铸造

- [ ] Ming 发起 `MINT_NFT_REQUEST` 后钱包收到并弹出确认
- [ ] 请求体包含 `timing`，钱包按 `strategy` 执行（`immediate` 立即执行）
- [ ] 用户确认后成功上链，返回 `tokenId(业务标识)/txHash/blockNumber`
- [ ] 用户拒绝时返回 `TRANSACTION_REJECTED`
- [ ] 合约失败时返回 `CONTRACT_CALL_FAILED` 或 `TRANSACTION_FAILED`

### 5.2 定时任务

- [ ] 创建任务返回 `taskId`
- [ ] 请求体包含 `timing.executeAt` 且与 `scheduledTime` 一致
- [ ] 查询单任务状态可读（pending/executing/completed/failed/cancelled）
- [ ] 查询钱包任务列表返回 `tasks[]`
- [ ] 取消任务可生效并可查询到状态变化
- [ ] 完成任务包含结果字段（`result.tokenId(业务标识)/txHash`）

### 5.3 封局释放

- [ ] Ming 发起 `RELEASE_CONNECTION_NFT_REQUEST` 后钱包收到并弹出确认
- [ ] 用户确认后成功上链，返回 `tokenId(业务标识)/txHash`
- [ ] `params.releasedTokenURI` 非 `ipfs://`/`https://` 时返回 `INVALID_PARAMS`
- [ ] 释放后 `releasedTokenURI` 元数据中可见封局评价参数（履约完成度/自我共振度/公开叙事摘要/下一阶段意图/释放时间）
- [ ] 释放后 NFT 元数据 `attributes` 包含上述评价参数条目

### 5.4 链族分组验收（多链执行视图）

Solana 组（`contract.chainFamily=solana`）：
- [ ] `contract.network` 校验通过时，铸造/封局流程可完成
- [ ] `contract.network` 与钱包网络不一致时返回 `CHAIN_NOT_SUPPORTED`
- [ ] `tokenId` 返回语义已固定（`connection_id` 或 mint 地址映射）并在联调记录中注明

EVM 组（`contract.chainFamily=evm`）：
- [ ] `contract.chainId` 校验通过时，铸造/封局流程可完成
- [ ] `contract.chainId` 与钱包当前链不一致时返回 `CHAIN_NOT_SUPPORTED`
- [ ] `tokenId` 返回为 EVM Token ID（十进制字符串）

---

## 6. 安全与风控

- [ ] 来源域名白名单生效（拒绝未知 origin）
- [ ] 关键操作有用户确认（铸造/取消）
- [ ] 错误信息最小披露，不泄漏敏感内部数据
- [ ] 重放/重复消息不会导致重复执行

---

## 7. 交付材料

- [ ] 目标链上地址（EVM 合约地址或 Solana Program ID）与 ABI/IDL 已确认
- [ ] 链参数（EVM: `chainId`；Solana: `network`；含 RPC/浏览器）已确认
- [ ] 允许来源域名（测试/生产）已确认
- [ ] 联调账户与样例 payload 已确认
- [ ] 钱包版本号与发布日期已记录

---

## 8. 验收记录

- 验收日期：
- 验收环境（测试网/主网）：
- 钱包版本：
- Ming 版本：
- 验收结论（通过/阻断）：
- 阻断项清单与修复计划：
