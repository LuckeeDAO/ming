# 钱包联调命令清单（可执行）

> 基线版本：v1.0（参照 `docs/00-现行口径基线.md`）

## 1. 目的

本清单将钱包文档中的“权限模型、协议实现、验收闭环”映射为可直接执行的命令序列，用于减少联调歧义。

## 2. 前置条件

- 已确认技术规范：`docs/钱包接口/钱包接口技术规范.md`
- 已确认权限决策：`docs/钱包接口/权限路径决策与实施清单.md`
- 已准备目标链上地址：`CONTRACT_ADDRESS`（EVM）或 `PROGRAM_ID`（Solana）
- 已配置对应网络 RPC 与签名账户

## 3. 命令序列

### 3.1 通用命令（全链共用）

#### 3.1.1 文档与口径检查

```bash
./scripts/check_docs_baseline.sh
```

预期：

- 输出 `Docs baseline check passed.`

#### 3.1.2 前端钱包接口单元测试

```bash
cd srcs
npm install
npm run test -- mingWalletInterface
npm run test -- scheduledMint
```

预期：

- `MING_WALLET_*_REQUEST/RESPONSE` 通信流程通过
- 定时任务相关调用与错误分支通过

### 3.2 Solana 命令（当前已接入链路）

#### 3.2.1 合约侧编译与测试

```bash
cd contracts/solana
npm install
anchor build
anchor test
```

预期：

- 编译通过
- 测试覆盖 owner 与非 owner 的铸造成功路径

#### 3.2.2 协议联调（请求样例落库）

多链联调建议：

- 可先使用 `docs/钱包接口/AnDaoWallet联调专项清单.md` 的 Solana 样例请求，验证 `contract.chainFamily=solana` 与 `contract.network` 的参数校验。
- 也可使用 EVM 样例请求验证 `contract.chainFamily=evm` 与 `contract.chainId` 的参数校验。

### 3.3 多链协议联调（示例一：Solana）

生成最小请求样例文件（便于钱包侧直接导入调试）：

```bash
cat > /tmp/ming_solana_mint_request.json <<'JSON'
{
  "type": "MING_WALLET_MINT_NFT_REQUEST",
  "messageId": "msg_solana_cmd_001",
  "payload": {
    "protocolVersion": "1.0.0",
    "timing": {
      "requestedAt": "2026-02-24T00:00:00.000Z",
      "executeAt": "2026-02-24T00:00:00.000Z",
      "strategy": "immediate",
      "timezone": "Asia/Shanghai"
    },
    "ipfs": {
      "imageHash": "QmExampleImageHash",
      "metadataHash": "QmExampleMetadataHash",
      "imageURI": "ipfs://QmExampleImageHash",
      "tokenURI": "ipfs://QmExampleMetadataHash"
    },
    "consensusHash": "0x1111111111111111111111111111111111111111111111111111111111111111",
    "contract": {
      "address": "5Ga3kk79rpPJy5joLvZKoJowRsEGvfcMpSDqAahYEVKT",
      "chainId": 0,
      "chainFamily": "solana",
      "network": "solana-devnet"
    },
    "params": {
      "to": "8J8W1ahh6Y1cM1k8oYyU7F2jmYb5x1p6DYk7tV4hyU2S",
      "tokenURI": "ipfs://QmExampleMetadataHash",
      "externalObjectId": "wood_forest",
      "element": "木",
      "consensusHash": "0x1111111111111111111111111111111111111111111111111111111111111111"
    }
  }
}
JSON
```

查看样例内容：

```bash
cat /tmp/ming_solana_mint_request.json
```

预期：

- 钱包侧导入该请求后，若网络与参数匹配，应返回成功响应；
- 若 `contract.network` 与钱包网络不一致，应返回 `CHAIN_NOT_SUPPORTED`；
- 若 `timing` 缺失或 `protocolVersion` 非 `1.0.0`，应返回参数错误。

### 3.4 EVM 命令（并行可选链路）

#### 3.4.1 合约侧编译与测试

```bash
cd contracts
npm install
npm run compile
npm test
```

预期：

- 编译通过
- 测试覆盖 owner 与非 owner 的铸造成功路径

#### 3.4.2 铸造可达性检查（不发交易）

EVM 可达性检查：

```bash
cd contracts
CONTRACT_ADDRESS=0xYourConnectionNFTAddress \
npx hardhat run scripts/check_mint_permission.js --network sepolia
```

可选：验证第二账户（非 owner）成功路径

```bash
cd contracts
CONTRACT_ADDRESS=0xYourConnectionNFTAddress \
NON_OWNER_PRIVATE_KEY=0xYourNonOwnerPrivateKey \
npx hardhat run scripts/check_mint_permission.js --network sepolia
```

预期：

- Signer path `staticCall` 可执行
- Secondary signer path `staticCall` 也可执行（若提供 `NON_OWNER_PRIVATE_KEY`）
#### 3.4.3 多链协议联调（示例二：EVM）

生成最小 EVM 请求样例文件：

```bash
cat > /tmp/ming_evm_mint_request.json <<'JSON'
{
  "type": "MING_WALLET_MINT_NFT_REQUEST",
  "messageId": "msg_evm_cmd_001",
  "payload": {
    "protocolVersion": "1.0.0",
    "timing": {
      "requestedAt": "2026-02-24T00:00:00.000Z",
      "executeAt": "2026-02-24T00:00:00.000Z",
      "strategy": "immediate",
      "timezone": "Asia/Shanghai"
    },
    "ipfs": {
      "imageHash": "QmExampleImageHash",
      "metadataHash": "QmExampleMetadataHash",
      "imageURI": "https://gateway.pinata.cloud/ipfs/QmExampleImageHash",
      "tokenURI": "https://gateway.pinata.cloud/ipfs/QmExampleMetadataHash"
    },
    "consensusHash": "0x1111111111111111111111111111111111111111111111111111111111111111",
    "contract": {
      "address": "0xYourConnectionNFTAddress",
      "chainId": 11155111,
      "chainFamily": "evm",
      "network": "sepolia"
    },
    "params": {
      "to": "0xRecipientAddress",
      "tokenURI": "https://gateway.pinata.cloud/ipfs/QmExampleMetadataHash",
      "externalObjectId": "wood_forest",
      "element": "木",
      "consensusHash": "0x1111111111111111111111111111111111111111111111111111111111111111"
    }
  }
}
JSON
```

查看样例内容：

```bash
cat /tmp/ming_evm_mint_request.json
```

预期：

- 钱包侧导入该请求后，若 `chainId` 与网络匹配，应返回成功响应；
- 若 `chainId` 与钱包当前链不一致，应返回 `CHAIN_NOT_SUPPORTED`。

### 3.5 联调验收记录

执行并勾选：

- `docs/钱包接口/钱包联调验收清单.md`

至少保留以下证据：

- 权限检查脚本输出（owner/non-owner）
- 关键请求与响应样例（含 `messageId`）
- 封局释放请求与响应样例（`RELEASE_CONNECTION_NFT`）
- 验收环境、版本号与结论

## 4. 常见失败与处理

- `CHAIN_NOT_SUPPORTED`
  - 处理：修正钱包链配置（EVM: `contract.chainId`；Solana: `contract.network`）
- `Wallet request timeout`
  - 处理：检查钱包消息监听、白名单 origin、`messageId` 回传
- `CONTRACT_CALL_FAILED`
  - 处理：先排查权限路径，再排查参数合法性

## 5. 关联文档

- `docs/钱包接口/钱包接口技术规范.md`
- `docs/钱包接口/权限路径决策与实施清单.md`
- `docs/钱包接口/钱包联调验收清单.md`
- `docs/钱包接口/AnDaoWallet联调专项清单.md`
