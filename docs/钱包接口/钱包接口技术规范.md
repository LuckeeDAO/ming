# 钱包接口技术规范

> 基线版本：v1.0（参照 `docs/00-现行口径基线.md`）

## 概述

Ming平台通过钱包接口与钱包进行通信，实现NFT铸造和定时任务管理功能。本文档说明钱包端需要实现的接口规范。

## 适用对象与完整性

- 适用对象：外部钱包工程团队（实现 `window.postMessage` 协议对接）。
- 文档定位：钱包接口唯一技术权威（字段、流程、校验、安全与联调约束）。
- 完整性结论：本文件可用于工程落地，但必须严格按“必实现接口 + 校验规则 + 安全约束 + 超时约束”执行，避免出现联调可通但线上不稳定的情况。

## 权威性声明

- 钱包接口技术口径仅以本文为准。
- `docs/04-开发指南/钱包接口实现指导.md` 为迁移说明页，不再承载实现细节。
- `docs/钱包接口/钱包NFT铸造功能需求说明书.md` 为背景与决策记录，不作为技术验收依据。

## 通信方式

### 消息传递机制

使用 `window.postMessage` API 进行跨窗口通信：

```typescript
// Ming平台发送消息
window.postMessage({
  type: 'MING_WALLET_MINT_NFT_REQUEST',
  payload: { ... },
  messageId: 'unique-message-id'
}, '*');

// 钱包监听消息
window.addEventListener('message', (event) => {
  if (event.data.type?.startsWith('MING_WALLET_')) {
    // 处理消息
  }
});
```

### 消息格式

所有消息都遵循以下格式：

```typescript
interface WalletMessage {
  type: string;           // 消息类型，以 'MING_WALLET_' 开头
  payload: any;           // 消息负载
  messageId: string;      // 请求唯一ID（用于匹配请求和响应）
}
```

约定：`payload.protocolVersion` 为协议版本号；当前首版固定为 `1.0.0`。

### 响应格式

钱包响应消息格式：

```typescript
interface WalletResponse {
  type: string;           // 响应类型，以 'MING_WALLET_' 开头并以 _RESPONSE 结尾
  messageId: string;      // 对应的请求ID
  payload: {
    success: boolean;     // 是否成功
    data?: any;          // 成功时的数据
    error?: {            // 失败时的错误信息
      code: string;
      message: string;
      details?: any;
    };
  };
}
```

## 需要实现的接口

### 0. 必实现清单（MVP）

外部钱包工程**必须实现**以下消息对：

1. `MING_WALLET_MINT_NFT_REQUEST` / `MING_WALLET_MINT_NFT_RESPONSE`
2. `MING_WALLET_CREATE_SCHEDULED_TASK_REQUEST` / `MING_WALLET_CREATE_SCHEDULED_TASK_RESPONSE`
3. `MING_WALLET_GET_SCHEDULED_TASK_REQUEST` / `MING_WALLET_GET_SCHEDULED_TASK_RESPONSE`
4. `MING_WALLET_GET_SCHEDULED_TASKS_BY_WALLET_REQUEST` / `MING_WALLET_GET_SCHEDULED_TASKS_BY_WALLET_RESPONSE`
5. `MING_WALLET_CANCEL_SCHEDULED_TASK_REQUEST` / `MING_WALLET_CANCEL_SCHEDULED_TASK_RESPONSE`
6. `MING_WALLET_RELEASE_CONNECTION_NFT_REQUEST` / `MING_WALLET_RELEASE_CONNECTION_NFT_RESPONSE`

缺少其中任一项，Ming 端定时任务管理链路将出现功能缺口。

### 0.1 铸造权限模型（现行）

铸造指令现行口径为公开可调用（EVM: `mintConnection`，Solana: `mint_connection_nft`）：钱包签名账户不要求等于治理账户/合约 `owner`。

实施要求：

1. 允许 owner 与非 owner 账户均可发起铸造；
2. 继续执行字段合法性校验（地址、`consensusHash`、链参数）；
3. 治理类操作（如 `updateConsensusHash`）仍按合约治理权限执行。

铸造权限与风控核对请参照：`docs/钱包接口/权限路径决策与实施清单.md`

### 0.2 链族实现矩阵（当前状态）

| 功能项 | `chainFamily=solana` | `chainFamily=evm` |
|---|---|---|
| `MINT_NFT` | 已接入（可联调） | 占位（待映射文档补齐后联调） |
| `CREATE_SCHEDULED_TASK` | 已接入（可联调） | 占位（待映射文档补齐后联调） |
| `GET_SCHEDULED_TASK` | 已接入（可联调） | 占位（待映射文档补齐后联调） |
| `GET_SCHEDULED_TASKS_BY_WALLET` | 已接入（可联调） | 占位（待映射文档补齐后联调） |
| `CANCEL_SCHEDULED_TASK` | 已接入（可联调） | 占位（待映射文档补齐后联调） |
| `RELEASE_CONNECTION_NFT` | 已接入（可联调） | 占位（待映射文档补齐后联调） |

说明：

1. “占位”表示协议字段已预留，但该链族的专项映射、验收证据或代码路径尚未在本仓完成。
2. 多链总览见 `docs/智能合约/00-多链映射总览.md`。
3. EVM 占位映射文档见 `docs/智能合约/04-EVM映射占位文档.md`。

### 1. NFT铸造接口

#### 请求消息

**类型**: `MING_WALLET_MINT_NFT_REQUEST`

**负载**:
```typescript
interface MintNFTRequest {
  protocolVersion: string;       // 必填，固定为 1.0.0
  timing: {
    requestedAt: string;          // 请求发起时间（ISO）
    executeAt: string;            // 计划执行时间（ISO）
    strategy: 'immediate' | 'scheduled';
    timezone?: string;
  };
  ipfs: {
    imageHash: string;
    metadataHash: string;
    imageURI: string;
    tokenURI: string;
  };
  consensusHash: string;
  contract: {
    address: string;
    chainId: number; // EVM语义；Solana可传0用于兼容
    chainFamily?: 'evm' | 'solana';
    network?: string; // 如 sepolia / solana-devnet
  };
  params: {
    to: string;
    tokenURI: string;
    externalObjectId: string;
    element: string;
    consensusHash: string;
  };
}
```

**示例**:
```javascript
{
  type: 'MING_WALLET_MINT_NFT_REQUEST',
  payload: {
    protocolVersion: '1.0.0',
    ipfs: {
      imageHash: 'QmImageHash...',
      metadataHash: 'QmMetadataHash...',
      imageURI: 'https://gateway.pinata.cloud/ipfs/QmImageHash...',
      tokenURI: 'https://gateway.pinata.cloud/ipfs/QmMetadataHash...'
    },
    timing: {
      requestedAt: '2026-02-24T00:00:00.000Z',
      executeAt: '2026-02-24T00:00:00.000Z',
      strategy: 'immediate',
      timezone: 'Asia/Shanghai'
    },
    consensusHash: '0x1234567890abcdef...',
    contract: {
      address: '0xContractAddress...',
      chainId: 43114,
      chainFamily: 'evm',
      network: 'avalanche-mainnet'
    },
    params: {
      to: '0x1234...',
      tokenURI: 'https://gateway.pinata.cloud/ipfs/QmMetadataHash...',
      externalObjectId: 'wood_forest',
      element: '木',
      consensusHash: '0x1234567890abcdef...'
    }
  },
  messageId: 'msg_123456'
}
```

#### 响应消息

**类型**: `MING_WALLET_MINT_NFT_RESPONSE`

**成功响应**:
```typescript
interface MintNFTResponse {
  success: boolean;
  data?: {
    tokenId: string;      // 业务标识（EVM: tokenId；Solana: connection_id 或 mint 地址映射）
    txHash: string;       // 交易哈希
    blockNumber: number;
    timestamp?: number;
  };
  error?: {
    code: string;
    message: string;
    details?: any;
  };
}
```

**失败响应**:
```typescript
{
  success: false,
  error: {
    code: 'TRANSACTION_REJECTED' | 'INSUFFICIENT_BALANCE' | 'NETWORK_ERROR' | 'CONTRACT_CALL_FAILED',
    message: '错误描述'
  }
}
```

#### 实现要求

1. 验证用户已连接钱包
2. 按链族验证链参数（EVM 对齐 `chainId`；Solana 对齐 `network`）
3. 按 `contract.chainFamily` 执行对应链上调用（钱包侧执行）
   - EVM：调用 `mintConnection`
   - Solana：调用 `mint_connection_nft`
4. 等待交易确认
5. 从链上回执中提取业务标识（EVM 事件 Token ID / Solana connection_id 或 mint 地址）
6. 返回结果给Ming平台
7. 校验 `timing` 字段并执行时间策略：
   - `strategy=immediate`：可立即执行（`executeAt` 用于审计）
   - `strategy=scheduled`：必须进入钱包延时队列，到时执行

#### `tokenId` 返回语义（统一规则）

为兼容前端与历史协议，钱包响应仍使用 `data.tokenId: string`，但语义统一为“业务标识”：

1. EVM：返回链上 ERC-721 `tokenId`（十进制字符串）。
2. Solana：优先返回 `connection_id` 映射值（如 `connection:42`）；若钱包实现以 mint 地址为主，也可返回 mint 地址字符串。
3. 钱包团队需在联调材料中固定本环境的 Solana 返回策略，避免跨环境口径不一致。

#### Solana 最小可用样例（推荐）

请求：

```json
{
  "type": "MING_WALLET_MINT_NFT_REQUEST",
  "messageId": "msg_solana_min_001",
  "payload": {
    "protocolVersion": "1.0.0",
    "timing": {
      "requestedAt": "2026-02-24T00:00:00.000Z",
      "executeAt": "2026-02-24T00:00:00.000Z",
      "strategy": "immediate",
      "timezone": "Asia/Shanghai"
    },
    "ipfs": {
      "imageHash": "QmExampleImageHash",
      "metadataHash": "QmExampleMetadataHash",
      "imageURI": "ipfs://QmExampleImageHash",
      "tokenURI": "ipfs://QmExampleMetadataHash"
    },
    "consensusHash": "0x1111111111111111111111111111111111111111111111111111111111111111",
    "contract": {
      "address": "5Ga3kk79rpPJy5joLvZKoJowRsEGvfcMpSDqAahYEVKT",
      "chainId": 0,
      "chainFamily": "solana",
      "network": "solana-devnet"
    },
    "params": {
      "to": "8J8W1ahh6Y1cM1k8oYyU7F2jmYb5x1p6DYk7tV4hyU2S",
      "tokenURI": "ipfs://QmExampleMetadataHash",
      "externalObjectId": "wood_forest",
      "element": "木",
      "consensusHash": "0x1111111111111111111111111111111111111111111111111111111111111111"
    }
  }
}
```

成功响应（示例）：

```json
{
  "type": "MING_WALLET_MINT_NFT_RESPONSE",
  "messageId": "msg_solana_min_001",
  "payload": {
    "success": true,
    "data": {
      "tokenId": "connection:42",
      "txHash": "5a7mY5...SolanaSignature",
      "blockNumber": 289123456,
      "timestamp": 1770000000
    }
  }
}
```

失败响应（链参数不匹配示例）：

```json
{
  "type": "MING_WALLET_MINT_NFT_RESPONSE",
  "messageId": "msg_solana_min_001",
  "payload": {
    "success": false,
    "error": {
      "code": "CHAIN_NOT_SUPPORTED",
      "message": "contract.network 与当前钱包网络不一致"
    }
  }
}
```

### 2. 创建定时任务接口

#### 请求消息

**类型**: `MING_WALLET_CREATE_SCHEDULED_TASK_REQUEST`

**负载**:
```typescript
interface CreateScheduledTaskRequest {
  protocolVersion: string;       // 必填，固定为 1.0.0
  scheduledTime: string;          // ISO格式时间字符串
  timing: {
    requestedAt: string;
    executeAt: string;            // 必须等于 scheduledTime
    strategy: 'scheduled';
    timezone?: string;
  };
  ipfs: {
    imageHash: string;
    metadataHash: string;
    imageURI: string;
    tokenURI: string;
  };
  consensusHash: string;
  contract: {
    address: string;
    chainId: number; // EVM语义；Solana可传0用于兼容
    chainFamily?: 'evm' | 'solana';
    network?: string; // 如 sepolia / solana-devnet
  };
  params: {
    to: string;
    tokenURI: string;
    externalObjectId: string;
    element: string;
    consensusHash: string;
  };
}
```

#### 响应消息

**类型**: `MING_WALLET_CREATE_SCHEDULED_TASK_RESPONSE`

**成功响应**:
```typescript
{
  success: true,
  data: {
    taskId: string;        // 任务ID
  }
}
```

#### 实现要求

1. 验证时间是否为未来时间
2. 存储定时任务（钱包内部托管，可为本地安全存储或钱包后端）
3. 在指定时间执行NFT铸造
4. 返回任务ID

### 3. 查询定时任务接口

#### 请求消息

**类型**: `MING_WALLET_GET_SCHEDULED_TASK_REQUEST`

**负载**:
```typescript
interface GetScheduledTaskRequest {
  taskId: string;         // 任务ID
}
```

#### 响应消息

**类型**: `MING_WALLET_GET_SCHEDULED_TASK_RESPONSE`

**成功响应**:
```typescript
{
  success: true,
  data: {
    taskId: string;
    status: 'pending' | 'executing' | 'completed' | 'failed' | 'cancelled';
    scheduledTime: string;
    walletAddress?: string;
    ipfs?: { tokenURI?: string; imageURI?: string };
    result?: { tokenId?: string; txHash?: string; error?: string };
    createdAt: string;
    mintedAt?: string;
  }
}
```

### 4. 查询所有定时任务接口（必实现）

#### 请求消息

**类型**: `MING_WALLET_GET_SCHEDULED_TASKS_BY_WALLET_REQUEST`

**负载**:
```typescript
interface GetScheduledTasksByWalletRequest {
  protocolVersion: string; // 必填，固定为 1.0.0
  walletAddress: string;  // 钱包地址（必填）
}
```

#### 响应消息

**类型**: `MING_WALLET_GET_SCHEDULED_TASKS_BY_WALLET_RESPONSE`

**成功响应**:
```typescript
{
  success: true,
  data: {
    tasks: Array<{
      taskId: string;
      status: string;
      scheduledTime: string;
      // ... 其他字段
    }>;
  }
}
```

**说明**: 该接口为定时任务管理页的数据来源，钱包侧必须实现。

### 5. 取消定时任务接口

#### 请求消息

**类型**: `MING_WALLET_CANCEL_SCHEDULED_TASK_REQUEST`

**负载**:
```typescript
interface CancelScheduledTaskRequest {
  protocolVersion: string; // 必填，固定为 1.0.0
  taskId: string;         // 任务ID
}
```

### 6. 封局释放接口（必实现）

#### 请求消息

**类型**: `MING_WALLET_RELEASE_CONNECTION_NFT_REQUEST`

**负载**:
```typescript
interface ReleaseConnectionRequest {
  protocolVersion: string; // 必填，固定为 1.0.0
  contract: {
    address: string;
    chainId: number; // EVM语义；Solana可传0用于兼容
    chainFamily?: 'evm' | 'solana';
    network?: string;
  };
  params: {
    tokenId: string; // 业务标识
    releasedTokenURI: string; // ipfs:// 或 https://
    removePrivateData?: boolean;
  };
}
```

`releasedTokenURI` 对应的元数据内容要求（Ming 当前实现）：

1. 必须移除或隐藏隐私字段（如生辰明文、可逆敏感信息）。
2. 必须包含封局评价参数并写入 `attributes`，至少包含：
   - 履约完成度（`1-5`）
   - 自我共振度（`1-5`）
   - 公开叙事摘要
   - 下一阶段意图
   - 释放时间
3. 必须保留可验证的公开见证信息（例如 `consensusHash` 摘要或其发布状态标记）。

#### 响应消息

**类型**: `MING_WALLET_RELEASE_CONNECTION_NFT_RESPONSE`

**成功响应**:
```typescript
{
  success: true,
  data: {
    tokenId: string;
    txHash: string;
    blockNumber?: number;
    releasedTokenURI?: string;
    timestamp?: number;
  }
}
```

#### 响应消息

**类型**: `MING_WALLET_CANCEL_SCHEDULED_TASK_RESPONSE`

**成功响应**:
```typescript
{
  success: true,
  data: {
    taskId: string;
    cancelled: boolean;
  }
}
```

## 错误码定义

```typescript
enum WalletErrorCode {
  INVALID_PARAMS = 'INVALID_PARAMS',
  MISSING_REQUIRED_FIELD = 'MISSING_REQUIRED_FIELD',
  CONTRACT_NOT_INITIALIZED = 'CONTRACT_NOT_INITIALIZED',
  CONTRACT_CALL_FAILED = 'CONTRACT_CALL_FAILED',
  TRANSACTION_REJECTED = 'TRANSACTION_REJECTED',
  TRANSACTION_FAILED = 'TRANSACTION_FAILED',
  NETWORK_ERROR = 'NETWORK_ERROR',
  CHAIN_NOT_SUPPORTED = 'CHAIN_NOT_SUPPORTED',
  WALLET_NOT_CONNECTED = 'WALLET_NOT_CONNECTED',
  INSUFFICIENT_BALANCE = 'INSUFFICIENT_BALANCE',
  TASK_NOT_FOUND = 'TASK_NOT_FOUND',
  TASK_ALREADY_EXECUTED = 'TASK_ALREADY_EXECUTED',
  INVALID_SCHEDULED_TIME = 'INVALID_SCHEDULED_TIME'
}
```

## 字段校验规则（必做）

1. `messageId`：必填，原样回传，不得篡改。
2. `consensusHash`：必须为 `0x` 开头的 32 字节十六进制（长度 66）。
3. `contract.address`、`params.to`：按 `contract.chainFamily` 验证地址格式（`evm`/`solana`）。
4. EVM 场景：`contract.chainId` 必须与当前钱包链一致；不一致返回 `CHAIN_NOT_SUPPORTED`。
5. Solana 场景：`contract.network` 必填（如 `solana-devnet`），并与钱包当前网络一致。
6. `params.tokenURI`：必须使用 `ipfs://` 或 `https://` 协议。
7. `scheduledTime`：必须为未来 ISO 时间；过期返回 `INVALID_SCHEDULED_TIME`。
8. `timing`：必填；`timing.executeAt` 必须等于 `scheduledTime`，且 `timing.strategy='scheduled'`。
9. `protocolVersion`：必填，且固定值为 `1.0.0`。
10. `params.releasedTokenURI`：必须使用 `ipfs://` 或 `https://` 协议。
11. `releasedTokenURI` 对应元数据必须包含封局评价参数并写入公开 `attributes`。

## 超时与幂等（联调约束）

1. Ming 侧请求超时为 300 秒（`REQUEST_TIMEOUT = 300000ms`）。
2. 钱包需在超时内返回对应 `*_RESPONSE` 消息。
3. 对同一 `messageId`，钱包只应返回一次最终结果。
4. 未识别 `type` 的消息应忽略，不返回错误广播。

## 实现示例

### 1. 通用框架示例（全链）

```javascript
window.addEventListener('message', async (event) => {
  // 验证消息来源（必选）
  if (!ALLOWED_ORIGINS.includes(event.origin)) return;
  
  const { type, payload, messageId } = event.data;
  
  if (type === 'MING_WALLET_MINT_NFT_REQUEST') {
    try {
      // 执行NFT铸造
      const result = await mintNFT(payload);
      
      // 发送成功响应
      window.postMessage({
        type: 'MING_WALLET_MINT_NFT_RESPONSE',
        messageId,
        payload: {
          success: true,
          data: result
        }
      }, '*');
    } catch (error) {
      // 发送失败响应
      window.postMessage({
        type: 'MING_WALLET_MINT_NFT_RESPONSE',
        messageId,
        payload: {
          success: false,
          error: {
            code: getErrorCode(error),
            message: error.message
          }
        }
      }, '*');
    }
  }
  
  // 处理其他消息类型...
});
```

### 2. 链族分发示例（按 chainFamily）

```javascript
async function mintNFT(request) {
  const { params, contract } = request;
  const { to, tokenURI, externalObjectId, element, consensusHash } = params;
  
  // 1. 验证参数
  if (!to || !tokenURI || !externalObjectId || !element || !consensusHash) {
    throw new Error('Missing required parameters');
  }

  switch (contract.chainFamily) {
    case 'solana':
      return mintNFTOnSolana(request);
    case 'evm':
      return mintNFTOnEvm(request);
    default:
      throw new Error('Unsupported chainFamily');
  }
}
```

### 3. Solana 示例（当前已接入）

```javascript
async function mintNFTOnSolana(request) {
  const { params, contract } = request;
  const receipt = await sendSolanaMintTransaction({
    programId: contract.address,
    network: contract.network,
    recipient: params.to,
    tokenUri: params.tokenURI,
    externalObjectId: params.externalObjectId,
    element: params.element,
    consensusHash: params.consensusHash
  });

  return {
    tokenId: receipt.connectionId, // 或 mintAddress（按钱包实现）
    txHash: receipt.signature,
    blockNumber: receipt.slot
  };
}
```

### 4. EVM 示例（并行可选链路）

```javascript
async function mintNFTOnEvm(request) {
  const { params, contract } = request;
  const evmContract = await getEvmContract(contract.address);
  const tx = await evmContract.mintConnection(
    params.to,
    params.tokenURI,
    params.externalObjectId,
    params.element,
    params.consensusHash
  );
  const receipt = await tx.wait();
  const event = receipt.events.find((e) => e.event === 'ConnectionMinted');
  const tokenId = event.args.tokenId.toString();

  return {
    tokenId,
    txHash: receipt.transactionHash,
    blockNumber: receipt.blockNumber
  };
}
```

## 安全注意事项

1. **消息来源验证（必选）**: 只处理可信 `origin` 的消息，拒绝未知来源。
2. **请求-响应匹配（必选）**: 仅按 `messageId` 进行一对一响应。
3. **参数验证（必选）**: 按“字段校验规则”执行强校验。
4. **用户确认（必选）**: 铸造与取消等关键操作需显式用户确认。
5. **最小披露**: 钱包响应仅返回必要字段，避免泄漏内部实现细节。

## 联调验收用例（最小集合）

1. 正常铸造：`MINT_NFT_REQUEST -> MINT_NFT_RESPONSE(success=true)`
2. 链不匹配：返回 `CHAIN_NOT_SUPPORTED`
3. 用户拒绝交易：返回 `TRANSACTION_REJECTED`
4. 创建定时任务成功：返回 `taskId`
5. 查询任务列表成功：按钱包地址返回 `tasks[]`
6. 取消任务成功：返回 `success=true`（可选返回 `data.taskId/cancelled`）

## 外部钱包联调前置材料

在开始实现前，钱包团队需从 Ming 团队获取以下信息：

1. 目标链上程序地址（EVM 合约地址或 Solana Program ID，按环境区分）
2. ABI/IDL 与铸造结果解析约定（EVM 事件或 Solana 回执字段）
3. 链参数（EVM：`chainId`；Solana：`network`，以及对应 RPC）
4. 允许消息来源域名列表（生产/测试）
5. 联调账号与最小测试用例数据（地址、示例 payload）

## 测试建议

1. **单元测试**: 测试每个接口的参数验证和错误处理
2. **集成测试**: 测试与Ming平台的完整交互流程
3. **错误场景测试**: 测试各种错误情况（网络错误、用户拒绝等）
4. **并发测试**: 测试多个并发请求的处理

## 联系与支持

如有问题，请联系Ming平台开发团队。

## 相关联调资料

- 通用命令清单：`docs/钱包接口/钱包联调命令清单.md`
- AnDaoWallet 专项：`docs/钱包接口/AnDaoWallet联调专项清单.md`

---

**文档版本**: 1.0  
**最后更新**: 2026-02-24
