# 前端详细设计

## 1. 项目结构

### 1.1 目录结构

```
src/
├── components/              # 通用组件
│   ├── common/             # 基础组件
│   │   ├── Button/
│   │   ├── Input/
│   │   ├── Card/
│   │   └── Loading/
│   ├── layout/             # 布局组件
│   │   ├── Header/
│   │   ├── Footer/
│   │   ├── Sidebar/
│   │   └── Container/
│   ├── wallet/             # 钱包相关组件
│   │   ├── WalletConnect/
│   │   ├── WalletStatus/
│   │   └── NetworkSwitch/
│   ├── nft/                # NFT相关组件
│   │   ├── NFTMintForm/
│   │   ├── NFTGallery/
│   │   ├── NFTDetail/
│   │   └── NFTMetadata/
│   ├── ceremony/           # 仪式相关组件
│   │   ├── CeremonyGuide/
│   │   ├── ConnectionForm/
│   │   └── FeelingRecord/
│   └── energy/             # 能量分析组件
│       ├── FourPillarsInput/
│       ├── EnergyAnalysis/
│       ├── EnergyChart/
│       └── ExternalObjectCard/
├── pages/                  # 页面组件
│   ├── Home/
│   ├── Concept/
│   ├── ConnectionGuide/
│   ├── NFTCeremony/
│   ├── MyConnections/
│   ├── CeremonyResources/
│   └── About/
├── hooks/                  # 自定义Hooks
│   ├── useWallet.ts
│   ├── useNFT.ts
│   ├── useEnergyAnalysis.ts
│   ├── useIPFS.ts
│   └── useTranslation.ts
├── services/               # 服务层
│   ├── wallet/
│   │   ├── walletService.ts
│   │   └── walletTypes.ts
│   ├── contract/
│   │   ├── nftContract.ts
│   │   └── contractTypes.ts
│   ├── ipfs/
│   │   ├── ipfsService.ts
│   │   └── pinataService.ts
│   ├── energy/
│   │   ├── energyAnalysisService.ts
│   │   └── fourPillarsService.ts
│   └── api/
│       └── apiClient.ts
├── store/                  # 状态管理
│   ├── slices/
│   │   ├── walletSlice.ts
│   │   ├── nftSlice.ts
│   │   ├── energySlice.ts
│   │   └── uiSlice.ts
│   ├── hooks.ts
│   └── store.ts
├── utils/                  # 工具函数
│   ├── format.ts
│   ├── validation.ts
│   ├── constants.ts
│   └── helpers.ts
├── types/                  # TypeScript类型
│   ├── index.ts
│   ├── nft.ts
│   ├── energy.ts
│   ├── user.ts
│   └── api.ts
├── styles/                 # 样式文件
│   ├── theme.ts
│   ├── global.css
│   └── components/
├── i18n/                   # 国际化
│   ├── locales/
│   │   ├── zh/
│   │   └── en/
│   ├── config.ts
│   └── index.ts
├── assets/                 # 静态资源
│   ├── images/
│   ├── icons/
│   └── fonts/
├── App.tsx                 # 根组件
├── main.tsx               # 入口文件
└── vite-env.d.ts          # Vite类型声明
```

## 2. 核心组件设计

### 2.1 钱包连接组件

#### 2.1.1 WalletConnect组件
```typescript
// components/wallet/WalletConnect/index.tsx
interface WalletConnectProps {
  onConnect?: (address: string) => void;
  onDisconnect?: () => void;
}

const WalletConnect: React.FC<WalletConnectProps> = ({
  onConnect,
  onDisconnect,
}) => {
  const { address, isConnected, connect, disconnect } = useWallet();
  
  // 实现逻辑
};
```

#### 2.1.2 功能特性
- 支持MetaMask连接
- 支持WalletConnect
- 网络切换
- 连接状态显示
- 错误处理

### 2.2 四柱八字输入组件

#### 2.2.1 FourPillarsInput组件
```typescript
// components/energy/FourPillarsInput/index.tsx
interface FourPillarsInputProps {
  onSubmit: (data: FourPillars) => void;
  initialData?: FourPillars;
}

const FourPillarsInput: React.FC<FourPillarsInputProps> = ({
  onSubmit,
  initialData,
}) => {
  // 实现逻辑
  // - 天干地支选择器
  // - 表单验证
  // - 提交处理
};
```

#### 2.2.2 功能特性
- 天干地支下拉选择
- 实时验证
- 自动计算
- 数据持久化

### 2.3 能量分析展示组件

#### 2.3.1 EnergyAnalysis组件
```typescript
// components/energy/EnergyAnalysis/index.tsx
interface EnergyAnalysisProps {
  analysis: EnergyAnalysis;
  onRecommend?: () => void;
}

const EnergyAnalysis: React.FC<EnergyAnalysisProps> = ({
  analysis,
  onRecommend,
}) => {
  // 实现逻辑
  // - 五行能量图表
  // - 循环状态展示
  // - 缺失元素提示
};
```

#### 2.3.2 EnergyChart组件
- 使用Recharts绘制能量分布图
- 五行能量柱状图
- 循环状态可视化

### 2.4 外物推荐组件

#### 2.4.1 ExternalObjectCard组件
```typescript
// components/energy/ExternalObjectCard/index.tsx
interface ExternalObjectCardProps {
  object: ExternalObject;
  onSelect: (object: ExternalObject) => void;
  selected?: boolean;
}

const ExternalObjectCard: React.FC<ExternalObjectCardProps> = ({
  object,
  onSelect,
  selected,
}) => {
  // 实现逻辑
  // - 外物信息展示
  // - 选择交互
  // - 详情查看
};
```

### 2.5 NFT铸造组件

#### 2.5.1 NFTMintForm组件
```typescript
// components/nft/NFTMintForm/index.tsx
interface NFTMintFormProps {
  connectionRecord: ConnectionRecord;
  onMint: (metadata: NFTMetadata) => Promise<void>;
  onCancel: () => void;
}

const NFTMintForm: React.FC<NFTMintFormProps> = ({
  connectionRecord,
  onMint,
  onCancel,
}) => {
  // 实现逻辑
  // - 图片上传
  // - 元数据填写
  // - IPFS上传
  // - 合约调用
};
```

#### 2.5.2 功能流程
1. 图片上传和预览
2. 元数据表单填写
3. IPFS上传进度
4. 合约调用确认
5. 交易状态跟踪
6. 铸造完成展示

### 2.6 NFT展示组件

#### 2.6.1 NFTGallery组件
```typescript
// components/nft/NFTGallery/index.tsx
interface NFTGalleryProps {
  walletAddress: string;
  onSelect?: (nft: NFTOnChain) => void;
}

const NFTGallery: React.FC<NFTGalleryProps> = ({
  walletAddress,
  onSelect,
}) => {
  // 实现逻辑
  // - 查询用户NFT
  // - 网格展示
  // - 详情查看
};
```

## 3. 页面设计

### 3.1 首页 (Home)

#### 3.1.1 页面结构
```typescript
// pages/Home/index.tsx
const Home: React.FC = () => {
  return (
    <Container>
      <HeroSection />        {/* 英雄区域 */}
      <QuickStartSection />  {/* 快速开始 */}
      <FeatureSection />     {/* 功能特性 */}
      <StatsSection />       {/* 统计数据 */}
    </Container>
  );
};
```

#### 3.1.2 功能模块
- 平台介绍
- 快速入口
- 功能概览
- 用户统计

### 3.2 核心概念页 (Concept)

#### 3.2.1 页面结构
```typescript
// pages/Concept/index.tsx
const Concept: React.FC = () => {
  return (
    <Container>
      <ConceptIntroduction />  {/* 概念介绍 */}
      <EnergyCycleSection />   {/* 能量循环 */}
      <MissingElementSection /> {/* 缺失元素 */}
      <ExternalConnectionSection /> {/* 外物连接 */}
      <DisclaimerSection />    {/* 免责声明 */}
    </Container>
  );
};
```

### 3.3 连接指导页 (ConnectionGuide)

#### 3.3.1 页面结构
```typescript
// pages/ConnectionGuide/index.tsx
const ConnectionGuide: React.FC = () => {
  const [selectedObject, setSelectedObject] = useState<ExternalObject | null>(null);
  
  return (
    <Container>
      <GuideHeader />
      <EnergyAnalysisSection />    {/* 能量分析结果 */}
      <RecommendationSection />    {/* 外物推荐 */}
      <ObjectSelectionSection />   {/* 外物选择 */}
      <ConnectionMethodSection />  {/* 连接方式 */}
      <NextStepSection />          {/* 下一步 */}
    </Container>
  );
};
```

### 3.4 NFT仪式页 (NFTCeremony)

#### 3.4.1 页面结构
```typescript
// pages/NFTCeremony/index.tsx
const NFTCeremony: React.FC = () => {
  const [step, setStep] = useState(1);
  
  return (
    <Container>
      <CeremonyHeader />
      <Stepper currentStep={step} />
      {step === 1 && <PreparationStep />}
      {step === 2 && <ContentCreationStep />}
      {step === 3 && <MintingStep />}
      {step === 4 && <CompletionStep />}
    </Container>
  );
};
```

#### 3.4.2 步骤流程
1. **准备阶段**: 选择外物、准备素材
2. **内容创建**: 上传图片、填写信息
3. **铸造阶段**: IPFS上传、合约调用
4. **完成阶段**: 确认信息、记录感受

### 3.5 我的连接页 (MyConnections)

#### 3.5.1 页面结构
```typescript
// pages/MyConnections/index.tsx
const MyConnections: React.FC = () => {
  const { address } = useWallet();
  const { connections, loading } = useConnections(address);
  
  return (
    <Container>
      <ProfileHeader />
      <StatsSection />
      <ConnectionTimeline />
      <NFTGallery />
      <FeelingRecords />
    </Container>
  );
};
```

## 4. 状态管理设计

### 4.1 Redux Store结构

```typescript
// store/store.ts
interface RootState {
  wallet: WalletState;
  nft: NFTState;
  energy: EnergyState;
  ui: UIState;
}
```

### 4.2 Wallet Slice

```typescript
// store/slices/walletSlice.ts
interface WalletState {
  address: string | null;
  isConnected: boolean;
  networkId: number | null;
  balance: string | null;
  loading: boolean;
  error: string | null;
}
```

### 4.3 NFT Slice

```typescript
// store/slices/nftSlice.ts
interface NFTState {
  nfts: NFTOnChain[];
  selectedNFT: NFTOnChain | null;
  minting: boolean;
  mintingProgress: {
    step: string;
    progress: number;
  } | null;
  error: string | null;
}
```

### 4.4 Energy Slice

```typescript
// store/slices/energySlice.ts
interface EnergyState {
  fourPillars: FourPillars | null;
  analysis: EnergyAnalysis | null;
  recommendedObjects: ExternalObject[];
  selectedObject: ExternalObject | null;
  loading: boolean;
  error: string | null;
}
```

## 5. 服务层设计

### 5.1 钱包服务

```typescript
// services/wallet/walletService.ts
class WalletService {
  async connect(): Promise<string>;
  async disconnect(): Promise<void>;
  async switchNetwork(networkId: number): Promise<void>;
  async getBalance(address: string): Promise<string>;
  async signMessage(message: string): Promise<string>;
}
```

### 5.2 合约服务

```typescript
// services/contract/nftContract.ts
class NFTContractService {
  async mint(to: string, tokenURI: string): Promise<TransactionResponse>;
  async getTokenURI(tokenId: string): Promise<string>;
  async getOwner(tokenId: string): Promise<string>;
  async getBalanceOf(address: string): Promise<number>;
  async getTokensOfOwner(address: string): Promise<string[]>;
}
```

### 5.3 IPFS服务

```typescript
// services/ipfs/ipfsService.ts
class IPFSService {
  async uploadFile(file: File): Promise<string>;
  async uploadJSON(data: object): Promise<string>;
  async getFile(hash: string): Promise<Blob>;
  async getJSON(hash: string): Promise<any>;
}
```

### 5.4 能量分析服务

```typescript
// services/energy/energyAnalysisService.ts
class EnergyAnalysisService {
  analyze(fourPillars: FourPillars): EnergyAnalysis;
  recommendObjects(analysis: EnergyAnalysis): ExternalObject[];
  checkCirculation(analysis: EnergyAnalysis): CirculationStatus;
}
```

## 6. 路由设计

### 6.1 路由配置

```typescript
// App.tsx
const routes = [
  { path: '/', element: <Home /> },
  { path: '/concept', element: <Concept /> },
  { path: '/connection-guide', element: <ConnectionGuide /> },
  { path: '/nft-ceremony', element: <NFTCeremony /> },
  { path: '/my-connections', element: <MyConnections /> },
  { path: '/ceremony-resources', element: <CeremonyResources /> },
  { path: '/about', element: <About /> },
];
```

### 6.2 路由守卫

```typescript
// 需要钱包连接的路由
const ProtectedRoute: React.FC<{ children: React.ReactNode }> = ({
  children,
}) => {
  const { isConnected } = useWallet();
  
  if (!isConnected) {
    return <Navigate to="/" replace />;
  }
  
  return <>{children}</>;
};
```

## 7. 样式设计

### 7.1 主题配置

```typescript
// styles/theme.ts
const theme = createTheme({
  palette: {
    primary: {
      main: '#...', // 主色调
    },
    secondary: {
      main: '#...', // 辅助色
    },
    // 五行颜色
    elements: {
      wood: '#...',
      fire: '#...',
      earth: '#...',
      metal: '#...',
      water: '#...',
    },
  },
  typography: {
    // 字体配置
  },
  // 其他主题配置
});
```

### 7.2 响应式设计

- 移动端优先
- 断点设置
- 组件适配

## 8. 错误处理

### 8.1 错误边界

```typescript
// components/common/ErrorBoundary.tsx
class ErrorBoundary extends React.Component {
  // 实现错误捕获
}
```

### 8.2 错误提示

- Toast通知
- 错误页面
- 重试机制

## 9. 性能优化

### 9.1 代码分割

```typescript
// 路由懒加载
const Home = lazy(() => import('./pages/Home'));
const Concept = lazy(() => import('./pages/Concept'));
```

### 9.2 图片优化

- 懒加载
- WebP格式
- CDN加速

### 9.3 缓存策略

- API响应缓存
- 静态资源缓存
- 本地数据缓存

## 10. 测试设计

### 10.1 单元测试

```typescript
// components/__tests__/WalletConnect.test.tsx
describe('WalletConnect', () => {
  it('should connect wallet', async () => {
    // 测试逻辑
  });
});
```

### 10.2 集成测试

- 组件集成测试
- 页面流程测试

### 10.3 E2E测试

- 用户完整流程测试
- 钱包交互测试
- NFT铸造流程测试
