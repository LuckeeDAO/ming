# 智能合约设计

## 1. 合约概述

### 1.1 合约目标

Ming平台的智能合约主要实现：
- **NFT铸造**: ERC-721标准的连接NFT
- **能量场见证**: 记录连接共识
- **所有权管理**: NFT转移和查询

### 1.2 合约架构

```
MingPlatform/
├── ConnectionNFT.sol          # 主NFT合约
├── EnergyFieldWitness.sol     # 能量场见证合约（可选）
└── interfaces/
    └── IConnectionNFT.sol     # 接口定义
```

## 2. ConnectionNFT合约

### 2.1 合约结构

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/token/ERC721/extensions/ERC721URIStorage.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/utils/Counters.sol";

contract ConnectionNFT is ERC721URIStorage, Ownable {
    using Counters for Counters.Counter;
    
    // Token ID计数器
    Counters.Counter private _tokenIds;
    
    // 连接信息结构
    struct ConnectionInfo {
        uint256 tokenId;
        address owner;
        string tokenURI;
        uint256 connectionDate;
        string externalObjectId;
        string element;
        bytes32 consensusHash;
    }
    
    // Token ID => 连接信息
    mapping(uint256 => ConnectionInfo) public connections;
    
    // 用户地址 => Token ID列表
    mapping(address => uint256[]) public userTokens;
    
    // 事件
    event ConnectionMinted(
        uint256 indexed tokenId,
        address indexed owner,
        string tokenURI,
        uint256 connectionDate,
        string externalObjectId,
        string element
    );
    
    event ConnectionUpdated(
        uint256 indexed tokenId,
        bytes32 consensusHash
    );
    
    // 构造函数
    constructor(string memory name, string memory symbol) 
        ERC721(name, symbol) 
    {
    }
    
    // 铸造NFT
    function mintConnection(
        address to,
        string memory tokenURI,
        string memory externalObjectId,
        string memory element,
        bytes32 consensusHash
    ) public onlyOwner returns (uint256) {
        _tokenIds.increment();
        uint256 newTokenId = _tokenIds.current();
        
        // 铸造NFT
        _mint(to, newTokenId);
        _setTokenURI(newTokenId, tokenURI);
        
        // 记录连接信息
        connections[newTokenId] = ConnectionInfo({
            tokenId: newTokenId,
            owner: to,
            tokenURI: tokenURI,
            connectionDate: block.timestamp,
            externalObjectId: externalObjectId,
            element: element,
            consensusHash: consensusHash
        });
        
        // 记录用户Token
        userTokens[to].push(newTokenId);
        
        // 触发事件
        emit ConnectionMinted(
            newTokenId,
            to,
            tokenURI,
            block.timestamp,
            externalObjectId,
            element
        );
        
        return newTokenId;
    }
    
    // 更新共识哈希
    function updateConsensusHash(
        uint256 tokenId,
        bytes32 consensusHash
    ) public onlyOwner {
        require(_exists(tokenId), "Token does not exist");
        connections[tokenId].consensusHash = consensusHash;
        emit ConnectionUpdated(tokenId, consensusHash);
    }
    
    // 查询用户的所有Token
    function getUserTokens(address user) 
        public 
        view 
        returns (uint256[] memory) 
    {
        return userTokens[user];
    }
    
    // 查询连接信息
    function getConnectionInfo(uint256 tokenId)
        public
        view
        returns (ConnectionInfo memory)
    {
        require(_exists(tokenId), "Token does not exist");
        return connections[tokenId];
    }
    
    // 查询用户Token数量
    function getUserTokenCount(address user) 
        public 
        view 
        returns (uint256) 
    {
        return userTokens[user].length;
    }
}
```

### 2.2 功能说明

#### 2.2.1 mintConnection
- **功能**: 铸造连接NFT
- **参数**:
  - `to`: NFT接收地址
  - `tokenURI`: IPFS元数据URI
  - `externalObjectId`: 外物ID
  - `element`: 能量类型
  - `consensusHash`: 共识哈希
- **返回**: Token ID

#### 2.2.2 updateConsensusHash
- **功能**: 更新能量场见证共识哈希
- **参数**:
  - `tokenId`: Token ID
  - `consensusHash`: 新的共识哈希

#### 2.2.3 getUserTokens
- **功能**: 查询用户的所有NFT
- **参数**: `user`: 用户地址
- **返回**: Token ID数组

#### 2.2.4 getConnectionInfo
- **功能**: 查询连接信息
- **参数**: `tokenId`: Token ID
- **返回**: ConnectionInfo结构

## 3. 安全考虑

### 3.1 权限控制

```solidity
// 使用OpenZeppelin的Ownable
// 只有合约所有者可以铸造NFT
modifier onlyOwner() {
    require(owner() == _msgSender(), "Ownable: caller is not the owner");
    _;
}
```

### 3.2 输入验证

```solidity
// 验证地址
require(to != address(0), "Invalid address");

// 验证Token URI
require(bytes(tokenURI).length > 0, "Token URI cannot be empty");
```

### 3.3 重入攻击防护

```solidity
// 使用OpenZeppelin的ReentrancyGuard
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract ConnectionNFT is ERC721URIStorage, Ownable, ReentrancyGuard {
    function mintConnection(...) 
        public 
        onlyOwner 
        nonReentrant 
        returns (uint256) 
    {
        // 实现
    }
}
```

### 3.4 Gas优化

```solidity
// 使用Counters库管理Token ID
using Counters for Counters.Counter;

// 批量查询优化
function getUserTokens(address user) 
    public 
    view 
    returns (uint256[] memory) 
{
    return userTokens[user];
}
```

## 4. 事件设计

### 4.1 ConnectionMinted事件

```solidity
event ConnectionMinted(
    uint256 indexed tokenId,
    address indexed owner,
    string tokenURI,
    uint256 connectionDate,
    string externalObjectId,
    string element
);
```

### 4.2 ConnectionUpdated事件

```solidity
event ConnectionUpdated(
    uint256 indexed tokenId,
    bytes32 consensusHash
);
```

## 5. 接口定义

### 5.1 IConnectionNFT接口

```solidity
// interfaces/IConnectionNFT.sol
pragma solidity ^0.8.19;

interface IConnectionNFT {
    struct ConnectionInfo {
        uint256 tokenId;
        address owner;
        string tokenURI;
        uint256 connectionDate;
        string externalObjectId;
        string element;
        bytes32 consensusHash;
    }
    
    function mintConnection(
        address to,
        string memory tokenURI,
        string memory externalObjectId,
        string memory element,
        bytes32 consensusHash
    ) external returns (uint256);
    
    function getConnectionInfo(uint256 tokenId)
        external
        view
        returns (ConnectionInfo memory);
    
    function getUserTokens(address user) 
        external 
        view 
        returns (uint256[] memory);
}
```

## 6. 部署配置

### 6.1 网络配置

```javascript
// hardhat.config.js
module.exports = {
  networks: {
    mainnet: {
      url: process.env.MAINNET_RPC_URL,
      accounts: [process.env.PRIVATE_KEY],
    },
    goerli: {
      url: process.env.GOERLI_RPC_URL,
      accounts: [process.env.PRIVATE_KEY],
    },
  },
};
```

### 6.2 部署脚本

```javascript
// scripts/deploy.js
async function main() {
  const ConnectionNFT = await ethers.getContractFactory("ConnectionNFT");
  const nft = await ConnectionNFT.deploy(
    "Ming Connection NFT",
    "MING"
  );
  
  await nft.deployed();
  console.log("ConnectionNFT deployed to:", nft.address);
}
```

## 7. 测试设计

### 7.1 单元测试

```javascript
// test/ConnectionNFT.test.js
describe("ConnectionNFT", function () {
  it("Should mint a new NFT", async function () {
    // 测试逻辑
  });
  
  it("Should query user tokens", async function () {
    // 测试逻辑
  });
  
  it("Should update consensus hash", async function () {
    // 测试逻辑
  });
});
```

### 7.2 集成测试

- 完整铸造流程测试
- 多用户场景测试
- Gas消耗测试

## 8. 升级机制（可选）

### 8.1 代理模式

```solidity
// 使用OpenZeppelin的Upgradeable合约
import "@openzeppelin/contracts-upgradeable/token/ERC721/ERC721Upgradeable.sol";

contract ConnectionNFTUpgradeable is ERC721Upgradeable, OwnableUpgradeable {
    // 实现
}
```

## 9. 合约版本管理

### 9.1 版本号

- v1.0.0: 基础NFT功能
- v1.1.0: 添加能量场见证
- v2.0.0: 重大功能更新

### 9.2 向后兼容

- 保持接口不变
- 添加新功能而非修改现有功能
- 使用事件记录变更

## 10. Gas成本估算

### 10.1 操作Gas消耗

- **mintConnection**: ~150,000 gas
- **updateConsensusHash**: ~50,000 gas
- **getUserTokens**: ~30,000 gas (view函数，不消耗gas)
- **getConnectionInfo**: ~25,000 gas (view函数，不消耗gas)

### 10.2 优化建议

- 批量操作
- 使用事件而非存储
- 优化数据结构

## 11. 多链支持

### 11.1 支持的链

- Ethereum主网
- Polygon
- BSC (可选)
- Arbitrum (可选)

### 11.2 跨链考虑

- 使用相同的合约地址（如可能）
- 统一的接口标准
- 链标识符
