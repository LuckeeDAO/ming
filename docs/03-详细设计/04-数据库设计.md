# 数据库设计

## 1. 数据库概述

### 1.1 存储架构

Ming平台采用混合存储架构，不依赖传统关系型数据库：

- **链上存储**: NFT所有权、连接记录、能量场见证
- **IPFS存储**: 图片、元数据、详细记录
- **本地存储**: 用户临时数据、缓存、设置

### 1.2 设计原则

- **去中心化优先**: 尽可能使用链上存储
- **隐私保护**: 敏感数据不上链
- **成本优化**: 合理使用IPFS和本地存储
- **数据可验证**: 链上数据可公开验证

## 2. 链上数据模型

### 2.1 NFT合约存储

#### 2.1.1 数据结构
```solidity
// 智能合约中的存储结构
struct ConnectionInfo {
    uint256 tokenId;           // Token ID
    address owner;             // 所有者地址
    string tokenURI;          // IPFS元数据URI
    uint256 connectionDate;   // 连接时间戳
    string externalObjectId;   // 外物ID
    string element;            // 能量类型
    bytes32 consensusHash;    // 共识哈希
}

// 映射关系
mapping(uint256 => ConnectionInfo) public connections;
mapping(address => uint256[]) public userTokens;
```

#### 2.1.2 数据特点
- **不可变**: 一旦写入，不可修改（除共识哈希）
- **公开透明**: 所有数据可公开查询
- **去中心化**: 存储在区块链上，无需中心化服务器

### 2.2 事件日志

#### 2.2.1 事件定义
```solidity
event ConnectionMinted(
    uint256 indexed tokenId,
    address indexed owner,
    string tokenURI,
    uint256 connectionDate,
    string externalObjectId,
    string element
);
```

#### 2.2.2 日志查询
- 通过事件查询用户的所有连接记录
- 通过Token ID查询特定连接
- 通过时间范围查询连接记录

## 3. IPFS数据模型

### 3.1 NFT元数据

#### 3.1.1 元数据结构
```json
{
  "name": "Connection NFT #1",
  "description": "与木元素连接的仪式见证",
  "image": "ipfs://QmXXX...",
  "attributes": [
    {
      "trait_type": "External Object",
      "value": "wood-001"
    },
    {
      "trait_type": "Element",
      "value": "wood"
    },
    {
      "trait_type": "Connection Date",
      "value": "2024-01-01",
      "display_type": "date"
    }
  ],
  "connection": {
    "externalObjectId": "wood-001",
    "externalObjectName": "古树",
    "element": "wood",
    "connectionType": "deep",
    "connectionDate": "2024-01-01T00:00:00Z"
  },
  "ceremony": {
    "location": "某森林",
    "duration": "2小时"
  },
  "feelings": {
    "before": "仪式前的感受...",
    "during": "仪式中的感受...",
    "after": "仪式后的感受..."
  },
  "energyField": {
    "consensusHash": "0x...",
    "witnessCount": 0
  },
  "metadata": {
    "version": "1.0.0",
    "createdAt": "2024-01-01T00:00:00Z",
    "platform": "ming"
  }
}
```

#### 3.1.2 存储位置
- **IPFS哈希**: 存储在智能合约的`tokenURI`字段
- **内容寻址**: 通过IPFS哈希访问
- **永久存储**: 使用Pinata等固定服务

### 3.2 图片存储

#### 3.2.1 图片格式
- **格式**: JPEG, PNG, WebP
- **大小限制**: 最大10MB
- **分辨率**: 建议1000x1000以上

#### 3.2.2 存储结构
```
ipfs://{hash}/
├── image.jpg              # 主图片
└── thumbnail.jpg          # 缩略图（可选）
```

## 4. 本地存储模型

### 4.1 localStorage结构

#### 4.1.1 用户设置
```typescript
interface UserSettings {
  language: 'zh' | 'en';
  theme: 'light' | 'dark';
  network: 'mainnet' | 'testnet' | 'goerli';
  autoConnect: boolean;
}
```

#### 4.1.2 缓存数据
```typescript
interface CacheData {
  energyAnalysis?: {
    data: EnergyAnalysis;
    timestamp: number;
    expiresAt: number;
  };
  externalObjects?: {
    data: ExternalObject[];
    timestamp: number;
    expiresAt: number;
  };
  userNFTs?: {
    data: NFTOnChain[];
    timestamp: number;
    expiresAt: number;
  };
}
```

#### 4.1.3 草稿数据
```typescript
interface DraftData {
  connectionDraft?: {
    externalObjectId?: string;
    image?: File;
    notes?: string;
    feelings?: {
      before?: string;
      during?: string;
      after?: string;
    };
  };
  fourPillarsDraft?: {
    year?: string;
    month?: string;
    day?: string;
    hour?: string;
  };
}
```

### 4.2 IndexedDB结构（可选）

#### 4.2.1 使用场景
- 大量历史数据存储
- 离线数据访问
- 复杂查询需求

#### 4.2.2 数据表设计
```typescript
// 连接记录表
interface ConnectionRecordDB {
  id: string;
  walletAddress: string;
  nftTokenId: string;
  nftContractAddress: string;
  externalObjectId: string;
  connectionDate: Date;
  // ... 其他字段
  indexedFields: {
    walletAddress: string;
    connectionDate: number;
    element: string;
  };
}
```

## 5. 数据关系图

### 5.1 实体关系

```
User (钱包地址)
  ├── 1:N ConnectionRecord (连接记录)
  │     ├── 1:1 NFTOnChain (链上NFT)
  │     ├── 1:1 NFTMetadata (IPFS元数据)
  │     └── N:1 ExternalObject (外物)
  │
  ├── 1:1 UserFourPillars (四柱八字，本地存储)
  └── 1:N EnergyAnalysis (能量分析，本地存储)
```

### 5.2 数据流向

```
用户输入
  ↓
本地存储（临时）
  ↓
能量分析（本地计算或API）
  ↓
外物推荐（本地计算或API）
  ↓
用户选择
  ↓
IPFS上传（图片、元数据）
  ↓
智能合约（NFT铸造）
  ↓
链上存储（永久）
```

## 6. 数据查询设计

### 6.1 链上查询

#### 6.1.1 查询用户NFT
```typescript
// 通过合约方法查询
const tokenIds = await contract.getUserTokens(userAddress);

// 通过事件查询（更灵活）
const filter = contract.filters.ConnectionMinted(null, userAddress);
const events = await contract.queryFilter(filter);
```

#### 6.1.2 查询NFT详情
```typescript
// 获取链上信息
const connectionInfo = await contract.getConnectionInfo(tokenId);

// 获取IPFS元数据
const metadata = await fetch(`https://gateway.pinata.cloud/ipfs/${connectionInfo.tokenURI}`);
```

### 6.2 本地查询

#### 6.2.1 查询缓存
```typescript
function getCachedData<T>(key: string): T | null {
  const cached = localStorage.getItem(key);
  if (!cached) return null;
  
  const data = JSON.parse(cached);
  if (data.expiresAt < Date.now()) {
    localStorage.removeItem(key);
    return null;
  }
  
  return data.value;
}
```

#### 6.2.2 查询草稿
```typescript
function getDraft(key: string): any {
  const draft = localStorage.getItem(`draft_${key}`);
  return draft ? JSON.parse(draft) : null;
}
```

## 7. 数据同步策略

### 7.1 链上数据同步

#### 7.1.1 实时同步
- 监听合约事件
- 实时更新本地缓存
- 处理链重组

#### 7.1.2 批量同步
- 定期批量查询
- 增量更新
- 错误重试

### 7.2 IPFS数据同步

#### 7.2.1 缓存策略
- 本地缓存IPFS内容
- 使用多个网关
- 失败重试机制

## 8. 数据备份和恢复

### 8.1 备份策略

#### 8.1.1 链上数据
- 无需备份（区块链本身是备份）
- 记录合约地址和网络

#### 8.1.2 IPFS数据
- 使用Pinata固定服务
- 多节点备份
- 定期验证

#### 8.1.3 本地数据
- 导出功能
- 用户自行备份
- 加密存储

### 8.2 恢复策略

#### 8.2.1 数据恢复
- 从链上重新同步
- 从IPFS重新获取
- 从备份恢复本地数据

## 9. 数据隐私和安全

### 9.1 隐私保护

#### 9.1.1 不上链的数据
- 四柱八字详细信息
- 详细感受记录（用户选择）
- 用户个人设置

#### 9.1.2 加密存储
- 敏感数据加密
- 本地加密密钥
- 用户控制

### 9.2 数据安全

#### 9.2.1 输入验证
- 数据格式验证
- 大小限制
- 恶意内容检测

#### 9.2.2 访问控制
- 钱包签名验证
- 权限检查
- 防止未授权访问

## 10. 数据迁移

### 10.1 版本迁移

#### 10.1.1 元数据版本
- 版本号管理
- 向后兼容
- 迁移工具

#### 10.1.2 数据结构变更
- 保持接口兼容
- 渐进式迁移
- 数据转换

## 11. 性能优化

### 11.1 查询优化

#### 11.1.1 缓存策略
- 智能缓存
- 过期时间
- 缓存更新

#### 11.1.2 批量查询
- 批量获取NFT
- 并行请求
- 请求合并

### 11.2 存储优化

#### 11.2.1 数据压缩
- JSON压缩
- 图片优化
- 减少冗余

#### 11.2.2 索引优化
- 本地索引
- 快速查询
- 增量更新

## 12. 监控和统计

### 12.1 数据统计

#### 12.1.1 链上统计
- NFT铸造数量
- 用户数量
- 交易统计

#### 12.1.2 使用统计
- 功能使用情况
- 用户行为
- 性能指标

### 12.2 数据监控

#### 12.2.1 健康检查
- IPFS可用性
- 合约可用性
- 数据完整性

#### 12.2.2 异常检测
- 数据异常
- 访问异常
- 性能异常
